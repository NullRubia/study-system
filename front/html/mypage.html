<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ë§ˆì´í˜ì´ì§€</title>
  </head>
  <body>
    <h2>ğŸ™‹ ë§ˆì´í˜ì´ì§€</h2>

    <h3>íšŒì› ì •ë³´ ìˆ˜ì •</h3>
    <form onsubmit="updateInfo(event)">
      <input type="text" id="name" placeholder="ì´ë¦„" /><br />
      <input type="email" id="email" placeholder="ì´ë©”ì¼" /><br />
      <input type="password" id="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" /><br />
      <button type="submit">ìˆ˜ì •</button>
    </form>

    <h3>ğŸ“Œ ë‚´ê°€ ê°œì„¤í•œ ìŠ¤í„°ë””</h3>
    <ul id="myStudies"></ul>

    <h3>ğŸ“Œ ë‚´ê°€ ì‹ ì²­í•œ ìŠ¤í„°ë””</h3>
    <ul id="myApplications"></ul>

    <script>
      const token = localStorage.getItem("token");
      if (!token) location.href = "login.html";

      async function loadUserInfo() {
        const res = await fetch("http://localhost:8080/users/info", {
          headers: { Authorization: "Bearer " + token },
        });
        const user = await res.json();
        document.getElementById("name").value = user.name;
        document.getElementById("email").value = user.email;
      }

      async function updateInfo(e) {
        e.preventDefault();
        const data = {
          name: document.getElementById("name").value,
          email: document.getElementById("email").value,
          password: document.getElementById("password").value,
        };
        const res = await fetch("http://localhost:8080/users/update", {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify(data),
        });
        alert(res.ok ? "ìˆ˜ì • ì™„ë£Œ" : "ìˆ˜ì • ì‹¤íŒ¨");
      }

      async function loadMyStudies() {
        const res = await fetch("http://localhost:8080/studies/mine", {
          headers: { Authorization: "Bearer " + token },
        });

        if (!res.ok) {
          alert("ë‚´ ìŠ¤í„°ë”” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
          return;
        }

        const studies = await res.json();
        const ul = document.getElementById("myStudies");
        ul.innerHTML = "";

        studies.forEach((s) => {
          const li = document.createElement("li");
          li.innerHTML = `<a href="studyview.html?id=${s.id}">${s.title}</a>`;
          ul.appendChild(li);
        });
      }

      async function loadMyApplications() {
        const res = await fetch("http://localhost:8080/applications/mine", {
          headers: { Authorization: "Bearer " + token },
        });
        const apps = await res.json();
        const ul = document.getElementById("myApplications");
        ul.innerHTML = "";
        apps.forEach((a) => {
          const li = document.createElement("li");
          li.innerHTML = `<a href="studyview.html?id=${a.studyId}">${a.studyTitle}</a>`;
          ul.appendChild(li);
        });
      }

      (async () => {
        await loadUserInfo();
        await loadMyStudies();
        await loadMyApplications();
      })();
    </script>
  </body>
</html>
